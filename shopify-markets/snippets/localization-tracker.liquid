<script>
(function () {
  // Prevent duplicate loading
  if (window.__shopify_localization_state_loaded) return;
  window.__shopify_localization_state_loaded = true;

  const shopifyLocalization = {
    language: {{ localization.language.iso_code | json }},
    country: {{ localization.country.iso_code | json }},
    currency: {{ cart.currency.iso_code | default: shop.currency | json }},
    market_handle: {{ localization.market.handle | default: '' | json }},
    request_locale_iso_code: {{ request.locale.iso_code | json }}
  };

  // Push to dataLayer
  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({
    shopify: {
      localization: shopifyLocalization
    },
    event: 'shopify_localization_loaded'
  });

  // Build URL values
  const url = window.location.origin + window.location.pathname;
  const fullUrl = window.location.href;

  klaviyo.track('Loaded Shopify Localization - MM', {
    URL: url,
    FullURL: fullUrl,
    Localization: shopifyLocalization
  });
})();
</script>